#!/bin/bash

set -e

SCRIPTPATH=$(cd "$(dirname "$0")" && pwd -P)

usage () {
    echo "Usage: ./runbsc [v|s|c] <dir> <simout>?"
    echo "v compiles to verilog"
    echo "s runs the bsv simulator"
    echo "c cleans up files generated by bsc"
    echo "<dir> contains all user *.bsv files generated by pdl"
    echo "<simout> is optional and specifies the name of the output file for simulation results -- defaults to top.sim.out"
}

if [[ -z "$1" ]]
then
    usage
    exit 1
else
    CMD="$1"
fi

if [[ -z "$2" ]]
then
    WDIR="."
else
    WDIR="$2"
fi
if [[ -z "$3" ]]
then
    SIMOUT="top.sim.out"
else
    SIMOUT="$3"
fi

SCRIPTPATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
if [ -d "$WDIR" ]
then
    pushd "$WDIR"
else
    echo "$WDIR"" does not exist"
    exit 1
fi

RUNTIMEPATH=$(cd "$SCRIPTPATH/../bscRuntime" && pwd -P)
TOP=Circuit
TB="mkTB"
ARGS="-no-show-timestamps -no-show-version --aggressive-conditions"
BSC=$BLUESPECDIR/inst/bin/bsc
VPATH="-vsearch $BLUESPECDIR/src/Verilog:$BLUESPECDIR/src/Verilog.Vivado:$BLUESPECDIR/src/Verilog.Quartus:$RUNTIMEPATH/verilog"
VSIM="-vsim iverilog"
BSC_LIB_DIR="$RUNTIMEPATH/memories:$RUNTIMEPATH/verilog"
BPATH="-p .:$BSC_LIB_DIR:$BLUESPECDIR/inst/lib/Libraries/"
VDIR="$TOP"_verilog
SDIR="$TOP"_sim
mkdir -p $VDIR
mkdir -p $SDIR

case "$CMD" in
    "v")
	#Compile to Verilog
	"$BSC" $ARGS $BPATH -show-schedule -verilog -vdir $VDIR -u "$TOP".bsv
	;;
    "s")
	#Run simulation in Verilog
	"$BSC" $ARGS $BPATH $VPATH $VSIM -simdir $SDIR -u "$TOP".bsv
	"$BSC" $ARGS $VPATH $VSIM -verilog -simdir $SDIR -o "$TB".bexe -e "$TB" "$TB".v
	timeout 10s ./"$TB".bexe > "$SIMOUT"
	;;
    "c")
	rm -f *.bi *.bo *.ba
	rm -f *.cxx *.h *.o *.so *.bexe
	rm -f *.v *.vexe
	rm -f *.vcd *~ *.fsdb *.log
	rm -f *.sched
	rm -rf "$VDIR"
	rm -rf "$SDIR"
	;;
    *)
	usage
	;;
esac
eval "popd ; exit $?"

