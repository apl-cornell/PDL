#!/bin/bash


usage () {
    echo "Usage: ./runbsc [v|s|c] <dir>"
    echo "v compiles to verilog"
    echo "s runs the bsv simulator"
    echo "c cleans up files generated by bsc"
    echo "<dir> contains all user *.bsv files generated by pdl"
}

if [[ -z "$1" ]]
then
    usage
    exit 1
else
    CMD="$1"
fi

if [[ -z "$2" ]]
then
    WDIR="."
else
    WDIR="$2"
fi
SCRIPTPATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
if [ -d "$WDIR" ]
then
    pushd "$WDIR"
else
    echo "$WDIR"" does not exist"
    exit 1
fi
TOP=Circuit
TB="mkTB"
ARGS="-no-show-timestamps -no-show-version --aggressive-conditions"
BSC_LIB_DIR=$(realpath "$SCRIPTPATH"/../bscRuntime/locks)":"$(realpath "$SCRIPTPATH"/../bscRuntime/memories)
BPATH="-p .:"$BSC_LIB_DIR":"$BLUESPECDIR/inst/lib/Libraries/":%/Libraries"
VDIR="$TOP"_verilog
SDIR="$TOP"_sim
mkdir -p $VDIR
mkdir -p $SDIR

case "$CMD" in
    "v")
	#Compile to Verilog
	bsc $ARGS $BPATH -show-schedule -verilog -vdir $VDIR -u "$TOP".bsv
	;;
    "s")
	#Run simulation
	bsc $ARGS $BPATH -sim -simdir $SDIR -u "$TOP".bsv
	bsc $ARGS -sim -simdir $SDIR -o "$TB".bexe -e "$TB" "$TB".ba	
	timeout 10s ./"$TB".bexe > top.sim.out
	;;
    "c")
	rm -f *.bi *.bo *.ba
	rm -f *.cxx *.h *.o *.so *.bexe
	rm -f *.v *.vexe
	rm -f *.vcd *~ *.fsdb *.log
	rm -f *.sched
	rm -rf "$VDIR"
	rm -rf "$SDIR"
	;;
    *)
	usage
	;;
esac

popd
