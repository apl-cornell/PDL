#!/bin/bash

set -e

SCRIPTPATH=$(cd "$(dirname "$0")" && pwd -P)

usage () {
    echo "Usage: ./runbsc -w [v|s|c] <dir> <simout>?"
    echo "Using the -w flag will generate warnings, omitting it will suppress them."
    echo "Using the -t flag allows a timeout on simulation to be set (default 10s)"
    echo "v compiles to verilog"
    echo "s runs the bsv simulator"
    echo "c cleans up files generated by bsc"
    echo "<dir> contains all user *.bsv files generated by pdl"
    echo "<simout> is optional and specifies the name of the output file for simulation results -- defaults to top.sim.out"
}

WARN=" -suppress-warnings ALL "
while getopts ":wt:" opt; do
    case ${opt} in
	w )
	    WARN=""
	    ;;
	t )
	    TOUT=$OPTARG
	    ;;
	\? )
	    echo "Invalid Option: -$OPTARG" 1>&2
	    exit 1
	    ;;
    esac
done
shift $((OPTIND -1))

if [[ -z "$TOUT" ]]
then
    TOUT=10
fi

if [[ -z "$1" ]]
then
    usage
    exit 1
else
    CMD="$1"
fi

if [[ -z "$2" ]]
then
    WDIR="."
else
    WDIR="$2"
fi
if [[ -z "$3" ]]
then
    SIMOUT="top.sim.out"
else
    SIMOUT="$3"
fi

SCRIPTPATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
if [ -d "$WDIR" ]
then
    pushd "$WDIR"
else
    echo "$WDIR"" does not exist"
    exit 1
fi

RUNTIMEPATH=$(cd "$SCRIPTPATH/../bscRuntime" && pwd -P)
TOP=Circuit
TB="mkTB"
ARGS="$WARN""-u -no-show-timestamps -no-show-version --aggressive-conditions"
BSC=bsc
#for now just include both possible relative dirs
VPATH="-vsearch $BLUESPECDIR/src/Verilog:$BLUESPECDIR/lib/Verilog:$BLUESPECDIR/src/Verilog.Vivado:$BLUESPECDIR/lib/Verilog.Vivado:$BLUESPECDIR/src/Verilog.Quartus:$BLUESPECDIR/src/Verilog.Quartus:$RUNTIMEPATH/verilog"
VSIM="-vsim iverilog"
BSC_LIB_DIR="$RUNTIMEPATH/memories:$RUNTIMEPATH/verilog"
BPATH="-p .:$BSC_LIB_DIR:$BLUESPECDIR/inst/lib/Libraries/:$BLUESPECDIR/lib/Libraries/"
VDIR="$TOP"_verilog
SDIR="$TOP"_sim
mkdir -p $VDIR
mkdir -p $SDIR

case "$CMD" in
    "v")
	#Compile to Verilog
	"$BSC" $ARGS $BPATH -show-schedule -verilog -vdir $VDIR -u "$TOP".bsv
	;;
    "b")
	#Run simulation in Bluesim
	"$BSC" $ARGS -sim $BPATH "$TOP".bsv
	"$BSC" $ARGS $BPATH -sim -o "$TB".bexe -e "$TB" "$TB".ba
	timeout "$TOUT"s ./"$TB".bexe | grep -v "WARNING" > "$SIMOUT"	
	;;
    "s")
	#Run simulation in Verilog
	"$BSC" $ARGS $BPATH $VPATH $VSIM -vdir $VDIR -simdir $SDIR -u "$TOP".bsv
	"$BSC" $ARGS $VPATH $VSIM -verilog -vdir $VDIR -simdir $SDIR -o "$TB".bexe -e "$TB" "$VDIR"/"$TB".v
	timeout "$TOUT"s ./"$TB".bexe | grep -v "WARNING" > "$SIMOUT"
	;;
    "c")
	rm -f *.bi *.bo *.ba
	rm -f *.cxx *.h *.o *.so *.bexe
	rm -f *.v *.vexe
	rm -f *.vcd *~ *.fsdb *.log
	rm -f *.sched
	rm -rf "$VDIR"
	rm -rf "$SDIR"
	;;
    *)
	usage
	;;
esac
eval "popd ; exit $?"

