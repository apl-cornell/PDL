pipe testwrite(pc: int<32>)[rf: int<32>[5]<c4,s1>(CheckpointQueue), imem: int<40>[8]<a1,a1>]: bool {
     spec_check();
     start(imem);
     int<40> insn <- imem[cast(pc, uint<8>)];
     end(imem);
     ---
     spec_check();
     ---
     spec_check();
     int<32> data = insn{36:5};
     uint<5> addr = cast(insn{4:0}, uint<5>);
     start(rf);
     int<32> sdata = rf<a>[addr];
     //ERROR still need checkpoint here even though speccall is later
     //TODO allow this case if speculative thread really can't get here
     reserve(rf[addr], W); //stupid to put here, but doing it just for the sake of things
     end(rf);
     wdata = data + sdata;
     ---
     spec_check();
     s <- speccall testwrite(pc + 1);     
     block(rf[addr]);
     rf[addr] <- wdata;
     ---
     spec_barrier();

     nextPc = (addr{0:0} == 0) ? pc + 2 : pc + 1;
     verify(s, nextPc); //ERROR doesn't resolve speculation on some path
     print("ADDR: %d, DATA: %h", addr, wdata);
     release(rf[addr]);
}



circuit {
 ti = memory(int<40>, 8);
 rf = regfile(int<32>, 5);
 qrf = CheckpointQueue(rf);
 t = new testwrite[qrf, ti];
 call t(0<32>);	
}